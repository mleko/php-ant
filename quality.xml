<?xml version="1.0" encoding="UTF-8"?>
<project name="quality" basedir="." default="run" xmlns:phpant.quality="quality.phpant.mleko">

	<dirname property="include.basedir" file="${ant.file.quality}"/>
	<include file="${include.basedir}/common.xml"/>
	<!-- 
	============
	 PROPERTIES
	============
	-->
	<!-- Init default properties -->
	<target name="init" depends="common.init">
		<property name="phpant.config.quality.bin.dir" value="${phpant.config.common.vendor.dir}" relative="true"/>
		<property name="phpant.config.quality.src.dir" value="${phpant.config.common.src.dir}" relative="true"/>
		<property name="phpant.config.quality.output.dir" value="${basedir}/build/quality" relative="true"/>
		<property name="phpant.config.quality.phpdox.project" value="${phpant.config.common.project.name}"/>
		
		<property name="phpant.config.quality.phpmetrics.bin" value="${phpant.config.quality.bin.dir}/phpmetrics" relative="true"/>
		
		<property name="phpant.config.quality.phpmd.bin" value="${phpant.config.quality.bin.dir}/phpmd" relative="true"/>
		<property name="phpant.config.quality.phpcd.rulesets" value="cleancode,codesize,controversial,design,naming,unusedcode"/>
		
		<property name="phpant.config.quality.phpcpd.bin" value="${phpant.config.quality.bin.dir}/phpcpd" relative="true"/>
		<property name="phpant.config.quality.phploc.bin" value="${phpant.config.quality.bin.dir}/phploc" relative="true"/>
        
		<property name="phpant.config.quality.phpcs.bin" value="${phpant.config.quality.bin.dir}/phpcs" relative="true"/>
		<property name="phpant.config.quality.phpcs.standard" value="PSR1,PSR2"/>
        
		<property name="phpant.config.quality.pdepend.bin" value="${phpant.config.quality.bin.dir}/pdepend" relative="true"/>

		<property name="phpant.config.quality.phpcodebrowser.bin" value="${phpant.config.quality.bin.dir}/phpcb" relative="true"/>
		
		<property name="phpant.config.quality.phpdox.bin" value="${phpant.config.quality.bin.dir}/phpdox" relative="true"/>
		<property name="phpant.config.quality.phpdox.workdir" value="${phpant.config.quality.output.dir}/phpdox/workdir" relative="true"/>
		<property name="phpant.config.quality.phpdox.outdir" value="${phpant.config.quality.output.dir}" relative="true"/>
	</target>

	<!-- Dump config to log and file -->
	<target name="dump-properties" depends="init, common.dump-properties" description="Init properties and dump them to file"/>

	<!-- 
	============
	 TARGETS
	============
	-->
	<target name="run" description="Run quality checks" depends="analyze, aggregate"/>
	
	<target name="analyze" depends="php-lint, phpmetrics, phpmd, phpcpd, phploc, phpcs"/>
	<target name="aggregate" depends="analyze, phpcodebrowser, phpdox"/>
	
	<target name="help">
		<echo>Supported libraries:</echo>
		<echo>Analyzers</echo>
		<echo>halleck45/phpmetrics</echo>
		<echo>phpmd/phpmd</echo>
		<echo>sebastian/phpcpd</echo>
		<echo>phploc/phploc</echo>
		<echo>squizlabs/php_codesniffer</echo>
		<echo>Aggregators</echo>
		<echo>mayflower/php-codebrowser</echo>
		<echo>theseer/phpdox</echo>
	</target>
	
	<!-- == Analyzers == -->
	
	<!-- lint -->
	<target name="php-lint" depends="init">
		<exec executable="/usr/bin/env" failonerror="true">
			<arg line="php"/>
			<arg line="-l"/>
			<arg line="${phpant.config.quality.src.dir}"/>
		</exec>
	</target>
	
	<!-- PHPMetrics https://github.com/Halleck45/PhpMetrics -->
	<target name="phpmetrics-exists" depends="init">
		<condition property="phpant.data.quality.phpmetrics.exists" value="true">
			<available file="${phpant.config.quality.phpmetrics.bin}"/>
		</condition>
	</target>
	<target name="phpmetrics" if="phpant.data.quality.phpmetrics.exists" depends="phpmetrics-exists">
		<exec executable="${phpant.config.quality.phpmetrics.bin}">
			<arg value="-q" />
			<arg line="--report-xml='${phpant.config.quality.output.dir}/phpmetrics/phpmetrics.xml'" />
			<arg line="--report-html='${phpant.config.quality.output.dir}/phpmetrics/phpmetrics.html'" />
			<arg line="--report-csv='${phpant.config.quality.output.dir}/phpmetrics/phpmetrics.csv'" />
			<arg line="--violations-xml='${phpant.config.quality.output.dir}/phpmetrics/violations.xml'" />
			
			<arg value="${phpant.config.quality.src.dir}"/>
		</exec>
	</target>
	
	<!-- PHPMessDetector http://phpmd.org/ -->
	<target name="phpmd-exists" depends="init">
		<condition property="phpant.data.quality.phpmd.exists" value="true">
			<available file="${phpant.config.quality.phpmd.bin}"/>
		</condition>
	</target>
	<target name="phpmd" if="phpant.data.quality.phpmd.exists" depends="phpmd-exists">
		<mkdir dir="${phpant.config.quality.output.dir}/phpmd"/>
		
		<exec executable="${phpant.config.quality.phpmd.bin}">
			<arg value="${phpant.config.quality.src.dir}"/>
			<arg value="xml" />
			<arg line="${phpant.config.quality.phpcd.rulesets}" />
			<arg line="--reportfile ${phpant.config.quality.output.dir}/phpmd/phpmd.xml" />
		</exec>
		<echo>Result code 2 for PHPMD means it detected rule violations. Don't panic</echo>
	</target>
	
	<!-- PHP Copy/Paste Detector https://github.com/sebastianbergmann/phpcpd -->
	<target name="phpcpd-exists" depends="init">
		<condition property="phpant.data.quality.phpcpd.exists" value="true">
			<available file="${phpant.config.quality.phpcpd.bin}"/>
		</condition>
	</target>
	<target name="phpcpd" if="phpant.data.quality.phpcpd.exists" depends="phpcpd-exists">
		<mkdir dir="${phpant.config.quality.output.dir}/phpcpd"/>
		<exec executable="${phpant.config.quality.phpcpd.bin}">
			<arg line="--log-pmd ${phpant.config.quality.output.dir}/phpcpd/phpcpd.xml" />

			<arg value="${phpant.config.quality.src.dir}"/>
		</exec>
	</target>

	<!-- PHPLOC https://github.com/sebastianbergmann/phploc -->
	<target name="phploc-exists" depends="init">
		<condition property="phpant.data.quality.phpcpd.exists" value="true">
			<available file="${phpant.config.quality.phploc.bin}"/>
		</condition>
	</target>
	<target name="phploc" if="phpant.data.quality.phpcpd.exists" depends="phploc-exists">
		<mkdir dir="${phpant.config.quality.output.dir}/phploc"/>
		<exec executable="${phpant.config.quality.phploc.bin}">
			<arg line="--log-csv ${phpant.config.quality.output.dir}/phploc/phploc.csv" />
			<arg line="--log-xml ${phpant.config.quality.output.dir}/phploc/phploc.xml" />

			<arg value="${phpant.config.quality.src.dir}"/>
		</exec>
	</target>

	<!-- PHP_CodeSniffer https://github.com/squizlabs/PHP_CodeSniffer -->
	<target name="phpcs-exists" depends="init">
		<condition property="phpant.data.quality.phpcs.exists" value="true">
			<available file="${phpant.config.quality.phpcs.bin}"/>
		</condition>
	</target>
	<target name="phpcs" if="phpant.data.quality.phpcs.exists" depends="phpcs-exists">
		<mkdir dir="${phpant.config.quality.output.dir}/phpcs"/>
		<exec executable="${phpant.config.quality.phpcs.bin}">
			<arg line="-n"/>
			<arg line="--ignore='*/bower_components/*'"/>
			<arg line="--standard=${phpant.config.quality.phpcs.standard}"/>
			<arg line="--report-full=${phpant.config.quality.output.dir}/phpcs/phpcs.full" />
			<arg line="--report-xml=${phpant.config.quality.output.dir}/phpcs/phpcs.xml" />
			<arg line="--report-checkstyle=${phpant.config.quality.output.dir}/phpcs/phpcs.checkstyle.xml" />
			<arg line="--report-csv=${phpant.config.quality.output.dir}/phpcs/phpcs.csv" />
			<arg line="--report-json=${phpant.config.quality.output.dir}/phpcs/phpcs.json" />
			<arg line="--report-summary=${phpant.config.quality.output.dir}/phpcs/phpcs.summary" />

			<arg value="${phpant.config.quality.src.dir}"/>
		</exec>
		<echo>Result code 1 for PHPCS means it detected rule violations. Don't panic</echo>
	</target>
	
	<!-- == Aggregators == -->
	<!-- PHP_CodeBrowser https://github.com/Mayflower/PHP_CodeBrowser -->
	<target name="phpcodebrowser-exists" depends="init">
		<condition property="phpant.data.quality.phpcodebrowser.exists" value="true">
			<available file="${phpant.config.quality.phpcodebrowser.bin}"/>
		</condition>
	</target>
	<target name="phpcodebrowser" if="phpant.data.quality.phpcodebrowser.exists" depends="phpcodebrowser-exists">
		<exec executable="${phpant.config.quality.phpcodebrowser.bin}">
			<!--<arg value="-q" />-->
			<arg line="--output='${phpant.config.quality.output.dir}/phpcodebrowser'" />
			<arg line="--log='${phpant.config.quality.output.dir}'" />
			<arg line="--source ${phpant.config.quality.src.dir}"/>
			<arg line="-vvv"/>
			<arg line="-E '#(.*\.(js|css|jpg|jpeg|png|html|xml))|(*/bower_components/*)#i'"/>
		</exec>
	</target>

	<!-- phpDox â€“ The PHP Documentation Generator http://phpdox.de/index.html -->
	<target name="phpdox-exists" depends="init">
		<condition property="phpant.data.quality.phpcodebrowser.exists" value="true">
			<available file="${phpant.config.quality.phpdox.bin}"/>
		</condition>
	</target>
	<target name="phpdox-config" depends="init, analyze" if="phpant.data.quality.phpcodebrowser.exists">
		<echo level="debug">Create phpDox config file</echo>
		<mkdir dir="${phpant.config.quality.output.dir}/phpdox/intermediate"/>
		<local name="quality.phpdox.properties.file"/>
		<property name="quality.phpdox.properties.file" value="${phpant.config.quality.output.dir}/phpdox/intermediate/properties.xml" relative="true"/>
		<property name="phpant.data.quality.phpdox.config.file" value="${phpant.config.quality.output.dir}/phpdox/intermediate/phpdox.xml" relative="true"/>
		<echoproperties destfile="${quality.phpdox.properties.file}" format="xml"/>
		<xslt in="${quality.phpdox.properties.file}" out="${phpant.data.quality.phpdox.config.file}" style="${include.basedir}/xsl/phpdox.xsl"/>
	</target>
	<target name="phpdox" depends="init, phpdox-exists, phpdox-config" if="phpant.data.quality.phpcodebrowser.exists">
		<exec executable="${phpant.config.quality.phpdox.bin}">
			<arg line="-f ${phpant.data.quality.phpdox.config.file}" />
		</exec>
	</target>

	<!-- 
	============
	 MACROS
	============
	-->

</project>