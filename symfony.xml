<?xml version="1.0" encoding="UTF-8"?>
<project name="symfony" basedir="." default="build" xmlns:mleko.symfony="symfony.ant.mleko">
	<!-- 
	============
	 PROPERTIES
	============
	-->
	
	<property name="properties.symfony" value="${basedir}/symfony.ant.properties"/>

	<!-- Load properties from file -->
	<condition property="symfony.properties.available" value="true">
		<available file="${properties.symfony}"/>
	</condition>
	<target name="load-properties" if="symfony.properties.available">
		<echo>Load properties from file ${properties.symfony}</echo>
		<property file="${properties.symfony}" relative="true"/>
	</target>

	<!-- Init default properties -->
	<target name="init" depends="load-properties">
		<property name="config.symfony.env" value="dev"/>
		<property name="config.symfony.console" value="${basedir}/app/console" relative="true"/>
	</target>

	<!-- Dump config to log and file -->
	<target name="dump-properties" depends="init" description="Init properties and dump them to file">
		<echo>Dump composer properties to file ${properties.symfony}</echo>

		<local name="symfony.properties.dir"/>
		<dirname property="symfony.properties.dir" file="${symfony.composer}"/>
		<mkdir dir="${symfony.properties.dir}"/>

		<echoproperties prefix="config.symfony."/>
		<echoproperties destfile="${properties.symfony}" prefix="config.symfony."/>
	</target>

	<!-- 
	============
	 TARGETS
	============
	-->
	<target name="build" description="Clear cache, prepare assets" depends="cache-clear, assetic, assets">
		<echo>Symfony app prepared for env: ${config.symfony.env}</echo>
	</target>

	<target name="cache-clear" description="Cleanup cache" depends="init">
		<mleko.symfony:command>cache:clear</mleko.symfony:command>
	</target>
	<target name="cache-warmup" description="Warmup cache" depends="init">
		<mleko.symfony:command>cache:warmup</mleko.symfony:command>
	</target>

	<target name="assetic" description="Dumping assets" depends="init">
		<mleko.symfony:command>assetic:dump</mleko.symfony:command>
	</target>

	<target name="assets" description="Installing assets" depends="init">
		<mleko.symfony:command>assets:install</mleko.symfony:command>
	</target>

	<!-- 
	============
	 MACROS
	============
	-->
	
	<!-- Macro simplifying use of composer -->
	<macrodef name="command" uri="symfony.ant.mleko">
		<text name="command"/>
		<attribute name="options" default=""/>
		<sequential>
			<local name="opts"/>
			<property name="opts" value="--env=${config.symfony.env} @{options}"/>
			<echo message="Run symfony console @{command}" level="verbose"/>
			<exec executable="${config.symfony.console}">
				<arg line="${opts}"/>
				<arg value="@{command}"/>
			</exec>
			<echo message="symfony console @{command} ended" level="verbose"/>
		</sequential>
	</macrodef>

</project>