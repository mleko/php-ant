<?xml version="1.0" encoding="UTF-8"?>
<project name="test" basedir=".">
	<!-- 
	============
	 PROPERTIES
	============
	-->

	<dirname property="include.basedir" file="${ant.file.quality}"/>
	<include file="${include.basedir}/common.xml"/>

	<!-- Init default properties -->
	<target name="init" depends="common.init">
		<property name="phpant.config.test.bin.dir" value="${basedir}/vendor/bin" relative="true"/>
		<property name="phpant.config.test.output.dir" value="${basedir}/build/test" relative="true"/>
		<property name="phpant.config.test.codecoverage" value="true"/>

		<property name="phpant.config.test.codeception.bin" value="${phpant.config.test.bin.dir}/codecept" relative="true"/>
		<property name="phpant.config.test.codeception.output.dir" value="${basedir}/${phpant.config.test.output.dir}/codeception"/>
		<property name="phpant.config.test.codeception.codecoverage" value="${phpant.config.test.codecoverage}"/>
	</target>

	<!-- Dump config to log and file -->
	<target name="dump-properties" depends="init, common.dump-properties" description="Init properties and dump them to file"/>

	<!-- 
	============
	 TARGETS
	============
	-->
	<target name="unit" description="Perform unit tests" depends="codeception-unit"/>

	<target name="help">
		<echo>Supported libraries:</echo>
		<echo>codeception/codeception</echo>
	</target>

	<!-- == Tests == -->


	<!-- codeception -->
	<target name="codeception-exists" depends="init">
		<condition property="phpant.data.test.codeception.exists" value="true">
			<available file="${phpant.config.test.codeception.bin}"/>
		</condition>
	</target>
	
	<target name="codeception-unit" if="phpant.data.test.codeception.exists" depends="codeception-exists">
		<mkdir dir="${phpant.config.test.codeception.output.dir}"/>
		
		<local name="coverageArgument"/>
		<local name="colors"/>
		<local name="command"/>
		
		<condition property="coverageArgument"
				value="--coverage-xml ${phpant.config.test.codeception.output.dir}/coverage.xml --coverage-html ${phpant.config.test.codeception.output.dir}/coverage"
				else="">
			<istrue value="${phpant.config.test.codeception.codecoverage}"/>
		</condition>
		<condition property="colors" value="--colors" else="--no-colors">
			<istrue value="${phpant.config.common.colors}"/>
		</condition>
		<property name="command" value="${colors} ${coverageArgument} unit"/>
		<exec executable="${phpant.config.test.codeception.bin}">
			<arg line="run"/>
			<arg line="--xml ${phpant.config.test.codeception.output.dir}/unit.xml"/>
			<arg line="--html ${phpant.config.test.codeception.output.dir}/unit.html"/>
			<arg line="${command}"/>
		</exec>
	</target>
</project>